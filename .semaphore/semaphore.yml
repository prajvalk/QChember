version: v1.0
name: Build Matrix Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
  containers:
    - name: main
      image: 'ubuntu:20.04'

blocks:
  - name: "Build Matrix"
    dependencies: []
    task:
      jobs:
        # ====================
        # GCC Debug builds
        # ====================
        - name: GCC + OpenBLAS + OpenMP=OFF + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: openblas
            - name: OPENMP
              value: OFF
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        - name: GCC + OpenBLAS + OpenMP=ON + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: openblas
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        - name: GCC + MKL + OpenMP=OFF + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: mkl
            - name: OPENMP
              value: OFF
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        - name: GCC + MKL + OpenMP=ON + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: mkl
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        - name: GCC + libFLAME+BLIS + OpenMP=OFF + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: blis
            - name: OPENMP
              value: OFF
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        - name: GCC + libFLAME+BLIS + OpenMP=ON + Debug
          env_vars:
            - name: COMPILER
              value: gcc
            - name: BLAS_VENDOR
              value: blis
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Debug
          commands:
            - .ci/build.sh

        # ====================
        # Clang Release builds (always OpenMP=ON)
        # ====================
        - name: Clang + OpenBLAS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: clang
            - name: BLAS_VENDOR
              value: openblas
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: Clang + MKL + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: clang
            - name: BLAS_VENDOR
              value: mkl
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: Clang + libFLAME+BLIS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: clang
            - name: BLAS_VENDOR
              value: blis
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        # ====================
        # Intel Release builds (always OpenMP=ON)
        # ====================
        - name: Intel + OpenBLAS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: intel
            - name: BLAS_VENDOR
              value: openblas
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: Intel + MKL + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: intel
            - name: BLAS_VENDOR
              value: mkl
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: Intel + libFLAME+BLIS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: intel
            - name: BLAS_VENDOR
              value: blis
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        # ====================
        # AMD Release builds (always OpenMP=ON)
        # ====================
        - name: AMD + OpenBLAS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: amd
            - name: BLAS_VENDOR
              value: openblas
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: AMD + MKL + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: amd
            - name: BLAS_VENDOR
              value: mkl
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh

        - name: AMD + libFLAME+BLIS + OpenMP=ON + Release
          env_vars:
            - name: COMPILER
              value: amd
            - name: BLAS_VENDOR
              value: blis
            - name: OPENMP
              value: ON
            - name: BUILD_TYPE
              value: Release
          commands:
            - .ci/build.sh
